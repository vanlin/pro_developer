# Docker 介绍

为什么会有 Docker  ？

容器有很长的历史，但传统容器复杂，不易安装，管理和自动化也很困难。Docker 让容器变的简单



Docker 提供了什么 ？

* 提供一个简单，轻量的创建容器的方式
* 职责分离：解决 **程序在我这里运行还是好的** 类似扯皮的问题
* 面向微服务架构：容器只运行一个进程，天生的支持分布式



Docker 的核心组件：

* Docker 客户端和服务器
* Docker 镜像
* Registry
* Docker 容器



Registry 的两种类型：

* 公共 Registry：也叫 Docker Hub，由 Docker 公司运营，已有上万活跃用户和公共镜像
* 私有 Registry：企业内部自己架设的私有 Registry



什么是 Docker 容器 ？

* 容器是 Docker 镜像的运行时，可以把镜像理解为对象，容器是对象的实例化
* 快速构建应用服务器，消息队列，实用工具，持续集成等……



Docker 的使用场景：

* 加速本地开发和流水线的构建
* 保证程序在多环境的结果一致
* 建立独立沙盒环境，保证应用程序环境隔离
* 降低大型分布式系统的实现成本



Docker 相关的资源：

<img src="https://pcloud-1258173945.cos.ap-guangzhou.myqcloud.com/uPic/image-20211105102445538.png" alt="image-20211105102445538" style="zoom:50%;" />





# Docker 安装

Docker 支持的环境：

* 基于 namespace，cgroups 实现：Ubuntu、REHL和常见的 Linux 发行版（推荐使用环境）
* 基于虚拟环境实现：OS X，Windows



Docker 依赖的运行环境：

* 64 位 CPU 架构的计算机，Docker 不支持 32 位 CPU
* Linux 3.8 或者更高版本的内核
* 内核必须支持和开启 cgroup、namepsace 功能



具体安装步骤参考官网，里面各系统的安装步骤，这里就不赘述了：

* [Install Docker Engine on CentOS](https://docs.docker.com/engine/install/centos/)
* [Install Docker Engine on RHEL](https://docs.docker.com/engine/install/rhel/)
* [Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/)



Docker 服务启动的相关命令如下：

```sh
# 在开机的时候自启动 docker 服务
$ sudo service docker start 

# 确认 docker 安装，查看 docker 详情
$ sudo docker info
Client:
 Context:    default
 Debug Mode: false
 ....
```





# Docker 使用

## 启动容器

第一次启动容器：

```sh
$ docker run -i -t ubuntu /bin/bash
latest: Pulling from library/ubuntu
7b1a6ab2e44d: Pull complete
Digest: sha256:626ffe58f6e7566e00254b638eb7e0f3b11d4da9675088f4781a50ae288f3322
Status: Downloaded newer image for ubuntu:latest
```

以上命令的几个要点说明：

* ubuntu：是一个常用的基础镜像，存储在 Docker Hub 公共的 Registry 上
* -i：代表开启 STDIN
* -t：为容器分配 tty 终端，这样才能进入容器执行 shell 交互，而不是在后台启动容器
* /bin/bash：在容器中启动 bash shell



所以，容器启动后交互如下：

```sh
root@fedde06b71fb:/#
```



进入容器后，你可以把它看做独立的操作系统，例如：

* 获取主机名，IP 地址等等
* 安装一个软件，例如 VIM

当所有工作结束后，输入 `exit` 就可以回到宿主机。退出容器后，容器也自动关闭了。通过 `docker ps -a` 可以看到所有停止运行的容器。 



## 容器命名

使用以上运行方式，Docker 会随机帮我们命名容器，通过 `docker ps -a` 可以证实：

```sh
CONTAINER ID   IMAGE       COMMAND                  CREATED          STATUS                         PORTS                                           NAMES
fedde06b71fb   ubuntu      "/bin/bash"              4 minutes ago    Exited (127) 3 seconds ago                                                     nostalgic_chatterjee
da4b9cbd1ffc   ubuntu      "/bin/bash"              9 minutes ago    Exited (0) 9 minutes ago                                                       competent_chatelet
8dd0e22bf4b0   ubuntu      "/bin/bash"              11 minutes ago   Exited (0) 9 minutes ago                                                       exciting_torvalds
```

可以看到 NAMES 列：`nostalgic_chatterjee`， `competent_chatelet`，`exciting_torvalds` 几个随机名字



平时使用更推荐使用自定义容器名称来替代容器 ID 或者随机命名的原因：

* 使用名称有助于分辨容器的作用
* 构建容器逻辑时，名称也有助于理解容器之间的逻辑关系
* 更好理解，更方面的管理容器



不使用随机命名，手动为容器命名的方式：

```sh
# 通过 --name 参数执行容器名称
$ docker run --name phoenix_container -i -t ubuntu /bin/bash

# 查看已启动的容器
$ docker ps
CONTAINER ID   IMAGE            COMMAND                  CREATED         STATUS         PORTS                                                  NAMES
b818850d849a   ubuntu           "/bin/bash"              3 minutes ago   Up 3 seconds                                                          phoenix_container

# 停止容器
$ docker stop phoenix_container

# 启动容器
$ docker start phoenix_container

# 重启容器
$ docker restart phoenix_container

# 重新进入容器会话
$ docker attach phoenix_container
```



## 守护容器

使用参数 -d 创建守护式容器：

> 守护式容器：将容器放后台运行，没有交互界面，适合长时间运行的服务程序

使用命令如下：

```sh
# 使用守护方式启动容器
$ docker run --name daemon_dave -d ubuntu /bin/sh -c "while true; do echo hello world; sleep 1; done"
e3451a99ff224cd0460fbe864f30dbce8f3718ed35a9f67ea64ab353283316d6

# 查看运行中容器日志
$ docker logs daemon_dave
hello world
hello world
hello world
...

# 查看跟踪运行中容器日志，并且加入时间戳
$ docker logs -ft daemon_dave
2021-11-05T05:38:50.418415308Z hello world
2021-11-05T05:38:51.421242712Z hello world
2021-11-05T05:38:52.424404860Z hello world
...

# 查看容器内的进程
$ docker top daemon_dave
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                12491               12472               0                   13:38               ?                   00:00:00            /bin/sh -c while true; do echo hello world; sleep 1; done
root                12938               12491               0                   13:42               ?                   00:00:00            sleep 1

# docker exec 命令是在 Docker 1.3 引入，早期版本不支持
# 在容器中执行命令，创建 /etc/new_config_file 文件
$ docker exec -d daemon_dave touch /etc/new_config_file

# 进入容器 shell 交互界面
$ docker exec -t -i daemon_dave /bin/bash
# 进入容器，检查文件是否创建
$ ls /etc | grep "new"
new_config_file

# 停止守护容器
$ docker stop daemon_dave
```

注意：

* docker stop 命令会向容器进程发送 SIGTERM 进程终止信号
* docker kill 命令会向容器进程发送 SIGTKILL  杀死进程信号（快速终止进程时使用）



容器自启动：

- --restart：自动重启容器

当容器意外或者因为错误终止的时候，我们告诉 Docker 让其自动重启该容器，命令如下：

```sh
$ docker run --restart=always --name daemon_dave -d ubuntu /bin/sh
```



## 其他常用指令

获取容器更多信息：

```sh
$ docker inspect daemon_dave
[
    {
        "Id": "e3451a99ff224cd0460fbe864f30dbce8f3718ed35a9f67ea64ab353283316d6",
        "Created": "2021-11-05T05:38:49.528637028Z",
        "Path": "/bin/sh",
        "Args": [
            "-c",
            "while true; do echo hello world; sleep 1; done"
        ]
# ....
```

`docker inspect`  还可以使用 `-f` 或者 `-format` 参数来查看指定结果

> -f 参数支持 go 语言模型，使用它的时候可以充分利用 Go 语言模板的优势



删除指定容器和删除所有容器：

```sh
# 不能删除运行中的容器
$ docker rm daemon_dave
Error response from daemon: You cannot remove a running container e3451a99ff224cd0460fbe864f30dbce8f3718ed35a9f67ea64ab353283316d6. Stop the container before attempting removal or force remove
# 停止容器
$ docker stop daemon_dave
# 删除指定容器
$ docker rm daemon_dave

# 一次删除所有容器（容器比较多的时候使用）
$ docker rm `docker ps -a -q`
b818850d849a
2d618276f90a
72e4525f6e95
68898041a136
08229fd20cb0
```



# Docker 镜像和仓库

## 引入镜像

容器是镜像的实例化，在 Docker 常用的镜像操作如下：

```sh
# 列出镜像
$ docker images
REPOSITORY               TAG       IMAGE ID       CREATED         SIZE
ubuntu                   latest    ba6acccedd29   2 weeks ago     72.8MB
srm_pgsql                latest    9c1eeb3e6b6f   3 months ago    275MB
```



镜像版本概念：

- 为了区分同一个镜像中的不同版本，Docker 提供 Tag 标签功能，通常放在容器名称后，例如：`ubuntu:12.04` 
- 在拉取，启动镜像的时候，带上 Tag 标签可以加载指定版本的镜像



运行容器时，镜像启动过程：

1. 当执行 `docker run` 命令时，Dokcer 会在本地查找指定镜像
2. 如果本地镜像不存在，Docker 会从 Docker Hub 下载该镜像
3. 如果没有指定镜像标签，Docker 会自动拉取 lastest 标签镜像（当然你也可以使用 `docker pull` 先将镜像拉取下来）



关于镜像的其他操作：

```sh
# 查看执行镜像的所有版本
$ docker images mysql
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
mysql        5.6       e1aa75e199d7   4 months ago   303MB

# 查找镜像，在 Docker Hub 公共仓库上查找 mysql
$ docker search mysql
NAME                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
mysql                             MySQL is a widely used, open-source relation…   11635     [OK]
mariadb                           MariaDB Server is a high performing open sou…   4429      [OK]
```

查找镜像的字段说明：

* NAME：镜像名称
* DESCRIPTION：镜像描述
* STARS：镜像受欢迎程度
* OFFICIAL：是否官方
* AUTOMATED：自动构建



## 管理镜像

构建镜像的两种方式：

* docker commit 命令（不推荐）
* docker build 命令 + Dockerfile 文件（推荐）



### docker commit 使用

```sh
# 将运行时容器，构建为镜像
$ docker commit 5f9806b295a7 phoenix/apache2
sha256:ad5657691a3358cba8cc12a7d0043f07d9f4db594b6de96229100f37ce9a9684

# 查看刚构建的镜像
$ docker images phoenix/apache2                                                                                                                                                                                                xiaobin@xiaobindeMacBook-Pro
REPOSITORY        TAG       IMAGE ID       CREATED          SIZE
phoenix/apache2   latest    ad5657691a33   33 seconds ago   217MB

# 查看镜像详情
$ docker inspect phoenix/apache2
[
    {
        "Id": "sha256:ad5657691a3358cba8cc12a7d0043f07d9f4db594b6de96229100f37ce9a9684",
        "RepoTags": [
            "phoenix/apache2:latest"
        ],
# .....

# 运行刚构建的镜像
$ docker run -i -t phoenix/apache2 /bin/bash
```



### Dockerfile 使用

Dockerfile 和 `docker build` 命令构建镜像是被推荐的方式，使用方式如下

- Dockerfile 使用 DSL 语法描述 Docker 镜像内容
- 在 Dockerfile 同目录使用 `docker build` 命令构建镜像



一个简单的 Dockerfile 示例：

```sh
# Version 0.0.1
FROM ubuntu:14.04
MAINTAINER Phoenix "xiaobin.phoenix@gmail.com"
# Run command in your container
RUN apt-get update
RUN apt-get install -y nginx
# Open Web Service
RUN echo 'hey i am in your container' \
  >/usr/share/nginx/html/index.html
EXPOST 80
```



