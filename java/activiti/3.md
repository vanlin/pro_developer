# Activiti 流程引擎的使用

## 流程引擎的配置

ProcessEngineConfiguration 对象就可以代表 Activiti 的全部配置。通常也是默认 `activiti.cfg.xml` 文件必须声明的 bean 对象

### 流程对象配置

ProcessEngineConfiguration 对象默认读取以下信息：
1. 到 ClassPath 目录下读取名为 `activiti.cfg.xml` 的配置文件
2. 并且解析 XML 和创建 `processEngineConfiguration` 实例

通常一个包含 dbcp 连接池的 `activiti.cfg.xml` 文件信息如下：
```xml
    <!--dbcp链接池-->
    <bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource">
        <property name="driverClassName" value="com.mysql.jdbc.Driver"/>
        <property name="url" value="jdbc:mysql://localhost:3306/activiti?characterEncoding=utf8"/>
        <property name="username" value="root"/>
        <property name="password" value="123456"/>
        <property name="maxActive" value="15"/>
        <property name="maxIdle" value="1"/>
        <property name="defaultAutoCommit" value="false" />
    </bean>

    <!--在默认方式下的 processEngineConfiguration -->
    <bean id="processEngineConfiguration"  class="org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration">
        <!--直接引用上面配置的链接池，更高效-->
        <property name="dataSource" ref="dataSource" />
        <!-- 构建引擎时，检查并在需要时更新表结构。表结构不存在则会创建。 -->
        <property name="databaseSchemaUpdate" value="true"/>
        <property name="asyncExecutorActivate" value="false" />
    </bean>
```


关于流程引擎配置文件，ProcessEngineConfiguration 还提供如下几种方式实现：
1. 读取自定义文件：通过 `createProcessEngineConfigurationFromResource` 方法实现
2. 读取输入流：通过 `createProcessEngineConfigurationFromInputStream` 方法实现
3. 无需参数的默认配置对象：通过 `createStandaloneInMemProcessEngineConfiguration` 实现
4. ……………… 

因为以上方法都不是很常用，所以这里就不赘述了。

### 数据源配置

**数据源配置**
Activiti 支持的数据库类型：
- H2（本地测试用）
- MySQL
- Oracle
- PostgreSQL
- DB2
- MSSQL

上面展示了 `processEngineConfiguration` 配置和 `dbcp` 结合使用的案例，这里也不赘述了。  
在 Activiti 中常用的连接数据源方法有以下几种：

processEngineConfiguration 中 `dataSource` 可以支持的数据源类型有：
- JDBC 配置
- DBCP 配置（上面案例）
- C3P0 配置（跟 DBCP 大同小异）

**数据库策略配置**

processEngineConfiguration 中 databaseSchemaUpdate 属性的三种策略：

1. false：检查数据库中的依赖表，如果没有表或表中的版本不匹配，则抛出异常
2. true：自动更新数据库中的表进行更新（没有表则自动创建），匹配则不做任何事情（常用选项）
3. create-drop：每次重启 Activiti 都会删除数据库，重新建立表结构（多用于单元测试）

注意：
1. Activiti 只会在流程引擎创建时、按照配置的策略进行创建，读取引擎配置的时候并不会创建表结构
2. Activiti 会根据你的 JDBC 信息判断你使用的数据库类型，无需单独声明 databaseType 属性（显的多次一举）


### 其他属性配置

**历史信息 history 配置**

历史信息在 processEngineConfiguration 对象中配置方式如下：

```xml
<property name="history" value="audit" />
```
它的四种 value 分别代表的含义是：
- none：不保存任何历史数据，可以让引擎最高效额的运行
- activity：保存流程实例和流程行为，相比 none 级别高一点
- audit：还会保存流程任务和数据属性，是 `history` 的默认值
- full：最高级别，除了 audit 全部数据外，还会保存流程相关的细节数据，不过性能会比较低

asyncExecutorActivate 异步执行器：默认为 false
mailServer* 邮件服务器配置：发送邮件的服务

### 流程对象分析

前面介绍了 ProcessEngineConfiguration 的属性配置和作用，下面看看它的继承关系

#### 子类和用途
- StandalongeProcessEngineConfiguration：默认会对 Activiti 进行事务管理，启动时会检查数据库结构和版本是否正确 ✅
- StandalongInMemProcessEngineConfiguration：具有事务管理，并且设置 `databaseSchemaUpdate`、`jdbcUrl` 属性，方便进行单元测试
- SpringProcessEngineConfiguration：从名字上看就知道是跟 Spring 整合的类
- JtaProcessEngine：使用 Jta 进行事务管理的类

一些自定义的配置：
- 自定义配置：继承 ProcessEngineConfigurationImpl，可以自定义一些属性
- 自定义拦截器：覆盖 ProcessEngineConfigurationImpl 的 `initCommandInterceptors()` 方法

## 流程引擎的创建


### 创建的方式

ProcessEngine 实例代表一个流程引擎（读配置文件创建）。通过以下几种方法，主要是获取 ProcessEngine 对象实例

```java
// 从 ProcessEngineConfiguration 中构建 ProcessEngine 实例
ProcessEngine processEngine = ProcessEngineConfiguration.createProcessEngineConfigurationFromResourceDefault().buildProcessEngine();
// 从 ProcessEngines 中获取默认的 ProcessEngine 实例
ProcessEngine defaultProcessEngine = ProcessEngines.getDefaultProcessEngine();
// 获取当前所有流程的实例 Map
Map<String, ProcessEngine> processEngines = ProcessEngines.getProcessEngines();
// 打印流程实例属性
Assert.assertNotEquals(processEngine, defaultProcessEngine);
// 当前流程实例数量
Assert.assertEquals(processEngines.size(), 1);
Assert.assertEquals(processEngines.get("default"), defaultProcessEngine);
```

因为可以自定义 xml 配置文件，创建基于不同配置文件的 `ProcessEngine` 对象，所以 Activiti 提供了一系列对 `ProcessEngine` 对象的注册、重载、删除方法（因为使用比较简单，而且频率比较低，这里就不展示代码了，简单说一下功能即可，需要的时候再查），方法如下：
1. registerProcessEngine(ProcessEngine processEngine)：向 ProcessEngines 注册一个 ProcessEngine 实例（记得先从自定义配置中创建 ProcessEngine 对象）
2. unregister(ProcessEngine processEngine)：向 ProcessEngines 注销一个 ProcessEngine 实例（本质只是对 Map 的 add/remove 操作而已）
3. retry(String resourceUrl)：重载执行加载 Activiti 配置文件动作，获取 ProcessEngineInfo 对象
4. destory()：销毁 ProcessEngines 中的所有流程实例

### 流程对象的内容

Activiti 对流程的操作集中在几个服务组件内，他们分别的职责是：（后面会详细说明组件的细分）
- RepositoryService：提供对于流程定义、流程部署的服务
- RuntimeService：提供对于流程运行、流程实例的管理和控制服务
- TaskService：提供对流程任务的管理和控制，例如任务提醒，任务完成和创建任务
- IdentityService：对于流程数据角色管理的 API 服务、包括用户组，用户之间的关系
- ManagementService：提供对于引擎的管理和维护服务
- HistoryService：提供对流程历史的操作服务，例如查看历史、删除历史数据等
- DynamicBpmnService：可以实现无需重新部署，即可修改流程模型的部分修改


从 ProcessEngine 对象中获取各个流程组件的方式：
```java
RepositoryService repositoryService = processEngine.getRepositoryService();
RuntimeService runtimeService = processEngine.getRuntimeService();
TaskService taskService = processEngine.getTaskService();
ManagementService managementService = processEngine.getManagementService();
HistoryService historyService = processEngine.getHistoryService();
DynamicBpmnService dynamicBpmnService = processEngine.getDynamicBpmnService();
```

