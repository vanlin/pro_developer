## 基础概念

### Kubernetes 介绍

通过 Kubernetes 解决单体的痛点：

- 应用程序能够 24/7 全天候使用
- 每天可以多次发布部署新版本的应用程序
- 应用程序能够以简单快速的方式发布和更新，而无需停机



Kubernetes 是用来管理容器的工具，在管理大规模的容器集群时，它还提供如下功能：

1. 服务注册和负载均衡





#### 创建容器集群

几个要点：

* **Kubernetes 协调一个高可用计算机集群，每个计算机作为独立单元互相连接工作。**
* 容器化的部署模型，与过去的那种应用直接以包的方式深度与主机集成的部署模型相比更灵活、更可用。



集群包含两种类型的资源:

- **Master** 调度整个集群：Master 协调集群中的所有活动，例如调度应用、维护应用的所需状态、应用扩容以及推出新的更新。可以理解为 Control Plane
- **Nodes** 负责运行应用：**Node 是一个虚拟机或者物理机，它在 Kubernetes 集群中充当工作机器的角色**，可以理解为 Worker 线程角色，**Node 使用 Master 暴露的 Kubernetes API 与 Master 通信**



集群概念图：

<img src="https://pcloud-1258173945.cos.ap-guangzhou.myqcloud.com/uPic/image-20211028162343176.png" alt="image-20211028162343176" style="zoom: 33%;" />



创建集群用到的几条的命令：

```sh
# 查看 minikube 版本
$ minikube version
# 启动 cluster 
$ minikube start
# 查看 kubectl 版本
$ kubectl version
# 查看 cluster details 
$ kubectl cluster-info
# 查看节点详情
$ kubectl get nodes

# kubectl get nodes 命令的 out put:
NAME       STATUS   ROLES                  AGE    VERSION
minikube   Ready    control-plane,master   5m5s   v1.20.2
```



#### 部署容器应用

完成创建集群后，一旦运行了 Kubernetes 集群后，就可以在其上部署容器化应用程序，部署应用的几个重点：

* **Deployment** 配置文件指挥 Kubernetes 如何创建和更新应用程序的实例
* 如果托管实例的节点关闭或被删除，则 Deployment 控制器会将该实例替换为群集中另一个节点上的实例**（自动修复）**



思考一下：

**在没有 Kubernetes 这种编排系统之前，通常是怎么处理实例故障的 ？**



部署示例：

使用 Kubernetes 命令行界面 **Kubectl** 创建和管理 Deployment，示例如下：

```sh
# 使用 kubectl create deployment 命令部署镜像
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1

# 访问 Pod API
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/
```



#### 应用程序探索

关于 Pod 的几个概念

* Pod是 Kubernetes 平台上的原子单元。 
* Pod 是 Kubernetes 抽象出来的，表示一组一个或多个应用程序容器（如 Docker）
* Pod 中的容器共享 IP 地址和端口，始终位于同一位置并且共同调度，并在同一工作节点上的共享上下文中运行。
* 当我们在 Kubernetes 上创建 Deployment 时，该 Deployment 会在其中创建包含容器的 Pod



Pod 概念图（来自[官网](https://kubernetes.io/zh/docs/tutorials/kubernetes-basics/explore/explore-intro/)）：

<img src="https://pcloud-1258173945.cos.ap-guangzhou.myqcloud.com/uPic/image-20211029151746119.png" alt="image-20211029151746119" style="zoom: 33%;" />



关于工作节点的几个概念：

* 工作节点是 Kubernetes 中的参与计算的机器，可以是虚拟机或物理计算机，具体取决于集群
* 每个工作节点由主节点管理。工作节点可以有多个 pod 



每个工作节点至少包含：

* Kubelet，负责 Kubernetes 主节点和工作节点之间通信的过程; 它管理 Pod 和机器上运行的容器
* 容器运行时（如 Docker）负责从仓库中提取容器镜像，解压缩容器以及运行应用程序



工作节点运行概览图：

<img src="https://pcloud-1258173945.cos.ap-guangzhou.myqcloud.com/uPic/image-20211029152213521.png" alt="image-20211029152213521" style="zoom:33%;" />

查看 Pod 和工作节点的常用命令，实例程序：

```sh
# 列出资源 Pods
$ kubectl get pods

NAME                                  READY   STATUS              RESTARTS   AGE
kubernetes-bootcamp-fb5c67579-j2l2x   0/1     ContainerCreating   0          6s

# 查看资源详情
$ kubectl describe pods

Name:         kubernetes-bootcamp-fb5c67579-j2l2x
Namespace:    default
Priority:     0
# ..... 关于 Pod 的更多信息，IP address，port，Image ID 等等


# 查看 Pods 容器中的日志
# Note: We don’t need to specify the container name, because we only have one container inside the pod.
$ kubectl logs $POD_NAME

# output:
Kubernetes Bootcamp App Started At: 2021-10-29T07:24:17.678Z | Running On:  kubernetes-bootcamp-fb5c67579-j2l2x 

Running On: kubernetes-bootcamp-fb5c67579-j2l2x | Total Requests: 1 | App Uptime: 363.007 seconds | Log Time: 2021-10-29T07:30:20.685Z

# 通过 kubectl exec 在容器中执行命令
# 查看容器环境
$ kubectl exec $POD_NAME -- env
# 进入容器
$ kubectl exec -ti $POD_NAME -- bash
# 退出容器
$ exit
```



总结，最常见的操作可以使用以下 kubectl 命令完成：

- **kubectl get** - 列出资源
- **kubectl describe** - 显示有关资源的详细信息
- **kubectl logs** - 打印 pod 和其中容器的日志
- **kubectl exec** - 在 pod 中的容器上执行命令





#### 应用外部可见

Kubernetes Service 概念：

