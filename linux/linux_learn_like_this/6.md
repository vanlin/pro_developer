## iptables 与 firewalld 防火墙

目前我对防火墙的理解就像一个国家的海关，也类似微服务的海关，就例如防火墙，首先会设定一个入境规则，如果访问的流量不符合服务器的"入境规则"，那么就会直接拒绝访问，对于符合规则的数据也会进行逐一检查身份和安全性，从而保证服务器的安全，下面我们就简单看看 Linux 防火墙的设置和使用



### 防火墙管理工具

Linux 防火墙策略可以基于流量、端口号、协议、应用等信息来制定规则，如果匹配规则就进行对应的处理（通过、拒绝），最终目的就是保证只有合法的流量可以访问服务器。从而保证系统和应用的安全。



在 RHEL 7 系统中，firewalld 取代了 iptables 成为系统默认防火墙，但是其实不管 iptables、firewalld 都不是真正的防火墙，他们只是制定策略的工具而已，所有的访问策略最终都会教给 Linux 内核层面的 `netfilter` 网络过滤器来处理，所以防火墙工具只要掌握一个就可以，没必要学会所有的工具 🔧



### iptables 

在早期的的 Linux 系统中，默认就是 iptables 来配置防火墙，所以目前大多数企业内部使用的还是 iptables，所有有必要大概了解一下 iptables 的基本使用方式。



#### 策略和规则链

防火墙的匹配策略是从上到下读取配置匹配规则，如果流量数据满足匹配规则后，有两种处理方式：

* 通过：当防火墙默认策略是拒绝的时候，如果流量匹配规则就放行访问
* 拒绝：当防火墙默认策略是通过的时候，如果流量匹配规则就拒绝访问



防火墙策略工具有大量的参数，学习难度较大，不过对于日常工作了解一些常用参数即可：

* iptables -L：查看已有的防火墙规则链
* iptables -F：清空已有的防火墙规则链
* iptables -P INPUT DROP：把默认的进入流量设置的拒绝策略

展示几个比较复杂访问策略规则设置

```bash
# 只允许指定网段的主机访问本机 22 端口，拒绝其他所有主机流量
$ iptables -I INPUT -s 192.168.10.0/24 -p -tcp --dport 22 -j ACCEPT
$ iptables -A INPUT -p tcp --dport 22 -j REJECT

# 拒绝所有人访问本机的 12345 端口的策略规则
$ iptables -I INPUT -p tcp --dport 12345 -j REJECT
$ iptables -I INPUT -p udp --dport 12345 -j REJECT

# 向 INPUT 规则链中添加拒绝所有主机访问本机 1000~1024 端口的策略规则
$ iptables -A INPUT -p tcp --dport 1000:1024 -j REJECT
$ iptables -A INPUT -p udp --dport 1000:1024 -j REJECT
```

另外关于防火墙策略配置还有两点注意事项：

1. 路由规则是从上到下匹配，一定要把允许策略放在拒绝策略前面，否则允许的策略在上面就会被拒绝掉，导致无法访问
2. 使用 iptables 命令配置的防火墙规则默认会在系统下一次重启时失效，如果 想让配置的防火墙策略永久生效，还要执行保存命令：`service iptables save`







